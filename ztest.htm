<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Thermal</title>
    <link rel="stylesheet" href="css/style.css">
    <script src="js/UTIF.js"></script>
    <script>
        function start() {
            //UTIF.replaceIMG()
            let xhr = new XMLHttpRequest();
            xhr.open("GET", "reference_01.tiff");
            xhr.responseType = "arraybuffer";
            xhr.onload = imgLoaded;
            xhr.send();
        }

        
        function imgLoaded(e) {
            //37510 User Comment
            var ifds = UTIF.decode(e.target.response);
            //console.log(JSON.stringify(ifds));
            //return;
            UTIF.decodeImage(e.target.response, ifds[0])
            var rgba = UTIF.toRGBA8(ifds[0]);  // Uint8Array with RGBA pixels
            console.log(ifds[0].width, ifds[0].height);
            let tags = ifds[0];//, ifds[0]);
            let exifIFD = tags.exifIFD;
            let userCommentTagID = "t37510";
            let userComment = exifIFD[userCommentTagID];
            let thermalData = JSON.parse(userComment);
            //console.log(userComment);
            let dateCaptured = thermalData.DateCaptured;
            let temperaturesInCelsius = thermalData.TemperaturesInCelsius;
            let imageDescription = thermalData.ImageDescription;
            console.log('TemperaturesInCelsius:' + temperaturesInCelsius.length);
            let max = -999
            for(let i=0;i<temperaturesInCelsius.length;i++){
                let val = temperaturesInCelsius[i];
                if(val>max){
                    max = val;
                }
            }
            console.log('max:'+max);


            let canvas = document.createElement("canvas");
            let ctx = canvas.getContext("2d");
            canvas.width = ifds[0].width;
            canvas.height = ifds[0].height;
            let imageData = ctx.createImageData(ifds[0].width, ifds[0].height);
            imageData.data.set(rgba);
            ctx.putImageData(imageData, 0, 0);
            //document.getElementById("holder").appendChild(canvas);

            let img = document.createElement("img");
            img.src = canvas.toDataURL();
            document.getElementById("holder").appendChild(img);

        }


    </script>
</head>

<body onload="start()">
    <div id="holder"></div>
</body>